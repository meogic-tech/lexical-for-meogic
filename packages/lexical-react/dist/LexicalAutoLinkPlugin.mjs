/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{AutoLinkNode as t,$isAutoLinkNode as e,$isLinkNode as n,$createAutoLinkNode as r}from"@lexical/link";import{useLexicalComposerContext as l}from"@lexical/react/LexicalComposerContext";import{mergeRegister as o}from"@lexical/utils";import{TextNode as i,$isTextNode as s,$isLineBreakNode as u,$isElementNode as g,$createTextNode as c,$getSelection as f,$isRangeSelection as a,$isNodeSelection as x}from"lexical";import{useEffect as h}from"react";var p=function(t){const e=new URLSearchParams;e.append("code",t);for(let t=1;t<arguments.length;t++)e.append("v",arguments[t]);throw Error(`Minified Lexical error #${t}; visit https://lexical.dev/docs/error?${e} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)};function d(t,e=(t=>t)){return n=>{const r=t.exec(n);return null===r?null:{index:r.index,length:r[0].length,text:r[0],url:e(r[0])}}}function m(t,e){for(let n=0;n<e.length;n++){const r=e[n](t);if(r)return r}return null}const T=/[.,;\s]/;function C(t){return T.test(t)}function b(t){return C(t[t.length-1])}function v(t){return C(t[0])}function L(t){let e=t.getPreviousSibling();return g(e)&&(e=e.getLastDescendant()),null===e||u(e)||s(e)&&b(e.getTextContent())}function S(t){let e=t.getNextSibling();return g(e)&&(e=e.getFirstDescendant()),null===e||u(e)||s(e)&&v(e.getTextContent())}function R(t,e,n,r){if(!(t>0?C(n[t-1]):L(r[0])))return!1;return e<n.length?C(n[e]):S(r[r.length-1])}function U(t,e,n){const r=[],l=[],o=[];let i=0,s=0;const u=[...t];for(;u.length>0;){const t=u[0],g=t.getTextContent().length,c=s;s+g<=e?(r.push(t),i+=g):c>=n?o.push(t):l.push(t),s+=g,u.shift()}return[i,r,l,o]}function N(t,e,n,l){const o=r(l.url,l.attributes);if(1===t.length){let r,i=t[0];0===e?[r,i]=i.splitText(n):[,r,i]=i.splitText(e,n);const s=c(l.text);return s.setFormat(r.getFormat()),s.setDetail(r.getDetail()),o.append(s),r.replace(o),i}if(t.length>1){const r=t[0];let l,i=r.getTextContent().length;0===e?l=r:[,l]=r.splitText(e);const u=[];let g;for(let e=1;e<t.length;e++){const r=t[e],l=r.getTextContent().length,o=i;if(o<n)if(i+l<=n)u.push(r);else{const[t,e]=r.splitText(n-o);u.push(t),g=e}i+=l}const h=f(),p=h?h.getNodes().find(s):void 0,d=c(l.getTextContent());return d.setFormat(l.getFormat()),d.setDetail(l.getDetail()),o.append(d,...u),p&&p===l&&(a(h)?d.select(h.anchor.offset,h.focus.offset):x(h)&&d.select(0,d.getTextContent().length)),l.replace(o),g}}function D(t,e,n){const r=t.getChildren(),l=r.length;for(let e=0;e<l;e++){const l=r[e];if(!s(l)||!l.isSimpleText())return F(t),void n(null,t.getURL())}const o=t.getTextContent(),i=m(o,e);if(null===i||i.text!==o)return F(t),void n(null,t.getURL());if(!L(t)||!S(t))return F(t),void n(null,t.getURL());const u=t.getURL();if(u!==i.url&&(t.setURL(i.url),n(i.url,u)),i.attributes){const e=t.getRel();e!==i.attributes.rel&&(t.setRel(i.attributes.rel||null),n(i.attributes.rel||null,e));const r=t.getTarget();r!==i.attributes.target&&(t.setTarget(i.attributes.target||null),n(i.attributes.target||null,r))}}function F(t){const e=t.getChildren();for(let n=e.length-1;n>=0;n--)t.insertAfter(e[n]);return t.remove(),e.map((t=>t.getLatest()))}function P(r,l,u){h((()=>{r.hasNodes([t])||p(77);const g=(t,e)=>{u&&u(t,e)};return o(r.registerNodeTransform(i,(t=>{const r=t.getParentOrThrow(),o=t.getPreviousSibling();if(e(r))D(r,l,g);else if(!n(r)){if(t.isSimpleText()&&(v(t.getTextContent())||!e(o))){const e=function(t){const e=[t];let n=t.getNextSibling();for(;null!==n&&s(n)&&n.isSimpleText()&&(e.push(n),!/[\s]/.test(n.getTextContent()));)n=n.getNextSibling();return e}(t);!function(t,e,n){let r=[...t];const l=r.map((t=>t.getTextContent())).join("");let o,i=l,s=0;for(;(o=m(i,e))&&null!==o;){const t=o.index,e=t+o.length;if(R(s+t,s+e,l,r)){const[l,,i,u]=U(r,s+t,s+e),g=N(i,s+t-l,s+e-l,o);r=g?[g,...u]:u,n(o.url,null),s=0}else s+=e;i=i.substring(e)}}(e,l,g)}!function(t,n,r){const l=t.getPreviousSibling(),o=t.getNextSibling(),i=t.getTextContent();e(l)&&!v(i)&&(l.append(t),D(l,n,r),r(null,l.getURL())),e(o)&&!b(i)&&(F(o),D(o,n,r),r(null,o.getURL()))}(t,l,g)}})))}),[r,l,u])}function w({matchers:t,onChange:e}){const[n]=l();return P(n,t,e),null}export{w as AutoLinkPlugin,d as createLinkMatcherWithRegExp};
