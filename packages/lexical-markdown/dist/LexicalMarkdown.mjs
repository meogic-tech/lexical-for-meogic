/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{$getRoot as t,$isElementNode as e,$isDecoratorNode as n,$isLineBreakNode as o,$isTextNode as r,$createTextNode as i,$createParagraphNode as s,$getSelection as c,$isParagraphNode as l,$createLineBreakNode as a,$isRangeSelection as f,$isRootOrShadowRoot as u,$createRangeSelection as g,$setSelection as p}from"lexical";import{$isListNode as d,$isListItemNode as m,ListNode as h,ListItemNode as x,$createListItemNode as T,$createListNode as C}from"@lexical/list";import{$isQuoteNode as y,HeadingNode as b,$isHeadingNode as v,QuoteNode as w,$createQuoteNode as E,$createHeadingNode as S}from"@lexical/rich-text";import{$findMatchingParent as $}from"@lexical/utils";import{$isCodeNode as F,CodeNode as k,$createCodeNode as P}from"@lexical/code";import{LinkNode as L,$isLinkNode as M,$createLinkNode as N}from"@lexical/link";function R(t,e){const n={};for(const o of t){const t=e(o);n[t]?n[t].push(o):n[t]=[o]}return n}function _(t){const e=R(t,(t=>t.type));return{element:e.element||[],textFormat:e["text-format"]||[],textMatch:e["text-match"]||[]}}const A=/[!-/:-@[-`{-~\s]/;function z(t,o,r,i){for(const e of o){const n=e.export(t,(t=>j(t,r,i)));if(null!=n)return n}return e(t)?j(t,r,i):n(t)?t.getTextContent():null}function j(t,i,s){const c=[],l=t.getChildren();t:for(const t of l){for(const e of s){const n=e.export(t,(t=>j(t,i,s)),((t,e)=>B(t,e,i)));if(null!=n){c.push(n);continue t}}o(t)?c.push("\n"):r(t)?c.push(B(t,t.getTextContent(),i)):e(t)?c.push(j(t,i,s)):n(t)&&c.push(t.getTextContent())}return c.join("")}function B(t,e,n){const o=e.trim();let r=o;const i=new Set;for(const e of n){const n=e.format[0],o=e.tag;if(O(t,n)&&!i.has(n)){i.add(n);O(I(t,!0),n)||(r=o+r);O(I(t,!1),n)||(r+=o)}}return e.replace(o,(()=>r))}function I(t,n){let o=n?t.getPreviousSibling():t.getNextSibling();if(!o){const e=t.getParentOrThrow();e.isInline()&&(o=n?e.getPreviousSibling():e.getNextSibling())}for(;o;){if(e(o)){if(!o.isInline())break;const t=n?o.getLastDescendant():o.getFirstDescendant();if(r(t))return t;o=n?o.getPreviousSibling():o.getNextSibling()}if(r(o))return o;if(!e(o))return null}return null}function O(t,e){return r(t)&&t.hasFormat(e)}const D="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,U=D&&"documentMode"in document?document.documentMode:null;D&&/Mac|iPod|iPhone|iPad/.test(navigator.platform),D&&/^(?!.*Seamonkey)(?=.*Firefox).*/i.test(navigator.userAgent),D&&"InputEvent"in window&&!U&&new window.InputEvent("input");const K=D&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent),V=D&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,W=(D&&/Android/.test(navigator.userAgent),D&&/^(?=.*Chrome).*/i.test(navigator.userAgent)),q=D&&/AppleWebKit\/[\d.]+/.test(navigator.userAgent)&&!W,G=/^\s{0,3}$/;function H(e){const n=_(e),o=function(t){const e={},n={},o=[],r="(?<![\\\\])";for(const r of t){const{tag:t}=r;e[t]=r;const i=t.replace(/(\*|\^|\+)/g,"\\$1");o.push(i),n[t]=K||V||q?new RegExp(`(${i})(?![${i}\\s])(.*?[^${i}\\s])${i}(?!${i})`):new RegExp(`(?<![\\\\${i}])(${i})((\\\\${i})?.*?[^${i}\\s](\\\\${i})?)((?<!\\\\)|(?<=\\\\\\\\))(${i})(?![\\\\${i}])`)}return{fullMatchRegExpByTag:n,openTagsRegExp:new RegExp((K||V||q?"":`${r}`)+"("+o.join("|")+")","g"),transformersByTag:e}}(n.textFormat);return(e,r)=>{const l=e.split("\n"),a=l.length,f=r||t();f.clear();for(let t=0;t<a;t++){const e=l[t];let r=!1;for(const o of n.element)if(o.getNumberOfLines){const n=e.match(o.regExp),c=o.getNumberOfLines(l,t);if(t+c>=l.length)continue;const a=l[t+c].match(o.regExp),u=i(l.slice(t+1,t+c).join("\n"));if(n&&a){const e=s();e.append(u),f.append(e),o.replace(e,[u],n,!0),t+=c,r=!0;break}}r||Q(e,f,n.element,o,n.textMatch)}const u=f.getChildren();for(const t of u)J(t)&&f.getChildrenSize()>1&&t.remove();null!==c()&&f.selectEnd()}}function J(t){if(!l(t))return!1;const e=t.getFirstChild();return null==e||1===t.getChildrenSize()&&r(e)&&G.test(e.getTextContent())}function Q(t,e,n,o,r){const c=t.trim(),f=i(c),u=s();u.append(f),e.append(u);let g=!1;for(const{regExp:e,replace:o}of n){const n=t.match(e);if(n){g=!0,f.setTextContent(t.slice(n[0].length)),o(u,[f],n,!0);break}}if(g||u.select(0,0),X(f,o,r),u.isAttached()&&c.length>0){const t=u.getPreviousSibling();if(l(t)||y(t)||d(t)){let e=t;if(d(t)){const n=t.getLastDescendant();e=null==n?null:$(n,m)}null!=e&&e.getTextContentSize()>0&&(e.splice(e.getChildrenSize(),0,[a(),...u.getChildren()]),u.remove())}}}function X(t,e,n){const o=t.getTextContent(),r=function(t,e){const n=t.match(e.openTagsRegExp);if(null==n)return null;for(const o of n){const n=o.replace(/^\s/,""),r=e.fullMatchRegExpByTag[n];if(null==r)continue;const i=t.match(r),s=e.transformersByTag[n];if(null!=i&&null!=s){if(!1!==s.intraword)return i;const{index:e=0}=i,n=t[e-1],o=t[e+i[0].length];if((!n||A.test(n))&&(!o||A.test(o)))return i}}return null}(o,e);if(!r)return void Y(t,n);let i,s,c;if(r[0]===o)i=t;else{const e=r.index||0,n=e+r[0].length;0===e?[i,s]=t.splitText(n):[c,i,s]=t.splitText(e,n)}i.setTextContent(r[2]);const l=e.transformersByTag[r[1]];if(l)for(const t of l.format)i.hasFormat(t)||i.toggleFormat(t);i.hasFormat("code")||X(i,e,n),c&&X(c,e,n),s&&X(s,e,n)}function Y(t,e){let n=t;t:for(;n;){for(const t of e){const o=n.getTextContent().match(t.importRegExp);if(!o)continue;const r=o.index||0,i=r+o[0].length;let s,c;0===r?[s,n]=n.splitText(i):[,s,c]=n.splitText(r,i),c&&Y(c,e),t.replace(s,o);continue t}break}}function Z(t,e,n){const o=n.length;for(let r=e;r>=o;r--){const e=r-o;if(tt(t,e,n,0,o)&&" "!==t[e+o])return e}return-1}function tt(t,e,n,o,r){for(let i=0;i<r;i++)if(t[e+i]!==n[o+i])return!1;return!0}function et(t,e=Et){const n=_(e),i=R(n.textFormat,(({tag:t})=>t[t.length-1])),s=R(n.textMatch,(({trigger:t})=>t));for(const n of e){const e=n.type;if("element"===e||"text-match"===e){const e=n.dependencies;for(const n of e)if(!t.hasNode(n))throw Error(`MarkdownShortcuts: missing dependency ${n.getType()} for transformer. Ensure node dependency is included in editor initial config.`)}}const l=(t,e,l)=>{(function(t,e,n,o){const r=t.getParent();if(!u(r)||t.getFirstChild()!==e)return!1;const i=e.getTextContent();if(" "!==i[n-1])return!1;for(const{regExp:r,replace:s}of o){const o=i.match(r);if(o&&o[0].length===n){const r=e.getNextSiblings(),[i,c]=e.splitText(n);return i.remove(),s(t,c?[c,...r]:r,o,!1),!0}}return!1})(t,e,l,n.element)||function(t,e,n){let o=t.getTextContent();const r=n[o[e-1]];if(null==r)return!1;e<o.length&&(o=o.slice(0,e));for(const e of r){const n=o.match(e.regExp);if(null===n)continue;const r=n.index||0,i=r+n[0].length;let s;return 0===r?[s]=t.splitText(i):[,s]=t.splitText(r,i),s.selectNext(0,0),e.replace(s,n),!0}return!1}(e,l,s)||function(t,e,n){const i=t.getTextContent(),s=e-1,l=i[s],a=n[l];if(!a)return!1;for(const e of a){const{tag:n}=e,a=n.length,u=s-a+1;if(a>1&&!tt(i,u,n,0,a))continue;if(" "===i[u-1])continue;const d=i[s+1];if(!1===e.intraword&&d&&!A.test(d))continue;const m=t;let h=m,x=Z(i,u,n),T=h;for(;x<0&&(T=T.getPreviousSibling())&&!o(T);)if(r(T)){const t=T.getTextContent();h=T,x=Z(t,t.length,n)}if(x<0)continue;if(h===m&&x+a===u)continue;const C=h.getTextContent();if(x>0&&C[x-1]===l)continue;const y=C[x-1];if(!1===e.intraword&&y&&!A.test(y))continue;const b=m.getTextContent(),v=b.slice(0,u)+b.slice(s+1);m.setTextContent(v);const w=h===m?v:C;h.setTextContent(w.slice(0,x)+w.slice(x+a));const E=c(),S=g();p(S);const $=s-a*(h===m?2:1)+1;S.anchor.set(h.__key,x,"text"),S.focus.set(m.__key,$,"text");for(const t of e.format)S.hasFormat(t)||S.formatText(t);S.anchor.set(S.focus.key,S.focus.offset,S.focus.type);for(const t of e.format)S.hasFormat(t)&&S.toggleFormat(t);return f(E)&&(S.format=E.format),!0}}(e,l,i)};return t.registerUpdateListener((({tags:e,dirtyLeaves:n,editorState:o,prevEditorState:i})=>{if(e.has("collaboration")||e.has("historic"))return;if(t.isComposing())return;const s=o.read(c),a=i.read(c);if(!f(a)||!f(s)||!s.isCollapsed())return;const u=s.anchor.key,g=s.anchor.offset,p=o._nodeMap.get(u);!r(p)||!n.has(u)||1!==g&&g>a.anchor.offset+1||t.update((()=>{if(p.hasFormat("code"))return;const t=p.getParent();null===t||F(t)||l(t,p,s.anchor.offset)}))}))}const nt=t=>(e,n,o)=>{const r=t(o);r.append(...n),e.replace(r),r.select(0,0)};const ot=t=>(e,n,o)=>{const r=e.getPreviousSibling(),i=e.getNextSibling(),s=T("check"===t?"x"===o[3]:void 0);if(d(i)&&i.getListType()===t){const t=i.getFirstChild();null!==t?t.insertBefore(s):i.append(s),e.remove()}else if(d(r)&&r.getListType()===t)r.append(s),e.remove();else{const n=C(t,"number"===t?Number(o[2]):void 0);n.append(s),e.replace(n)}s.append(...n),s.select(0,0);const c=function(t){const e=t.match(/\t/g),n=t.match(/ /g);let o=0;return e&&(o+=e.length),n&&(o+=Math.floor(n.length/4)),o}(o[1]);c&&s.setIndent(c)},rt=(t,e,n)=>{const o=[],r=t.getChildren();let i=0;for(const s of r)if(m(s)){if(1===s.getChildrenSize()){const t=s.getFirstChild();if(d(t)){o.push(rt(t,e,n+1));continue}}const r=" ".repeat(4*n),c=t.getListType(),l="number"===c?`${t.getStart()+i}. `:"check"===c?`- [${s.getChecked()?"x":" "}] `:"- ";o.push(r+l+e(s)),i++}return o.join("\n")},it={dependencies:[b],export:(t,e)=>{if(!v(t))return null;const n=Number(t.getTag().slice(1));return"#".repeat(n)+" "+e(t)},regExp:/^(#{1,6})\s/,replace:nt((t=>{const e="h"+t[1].length;return S(e)})),type:"element"},st={dependencies:[w],export:(t,e)=>{if(!y(t))return null;const n=e(t).split("\n"),o=[];for(const t of n)o.push("> "+t);return o.join("\n")},regExp:/^>\s/,replace:(t,e,n,o)=>{if(o){const n=t.getPreviousSibling();if(y(n))return n.splice(n.getChildrenSize(),0,[a(),...e]),n.select(0,0),void t.remove()}const r=E();r.append(...e),t.replace(r),r.select(0,0)},type:"element"},ct={dependencies:[k],export:t=>{if(!F(t))return null;const e=t.getTextContent();return"```"+(t.getLanguage()||"")+(e?"\n"+e:"")+"\n```"},getNumberOfLines:(t,e)=>{const n=/^```(\w{1,10})?\s?$/;let o=e;const r=t.length;for(;++o<r;){if(t[o].match(n))return o-e}return 1},regExp:/^```(\w{1,10})?\s?$/,replace:nt((t=>P(t?t[1]:void 0))),type:"element"},lt={dependencies:[h,x],export:(t,e)=>d(t)?rt(t,e,0):null,regExp:/^(\s*)[-*+]\s/,replace:ot("bullet"),type:"element"},at={dependencies:[h,x],export:(t,e)=>d(t)?rt(t,e,0):null,regExp:/^(\s*)(?:-\s)?\s?(\[(\s|x)?\])\s/i,replace:ot("check"),type:"element"},ft={dependencies:[h,x],export:(t,e)=>d(t)?rt(t,e,0):null,regExp:/^(\s*)(\d{1,})\.\s/,replace:ot("number"),type:"element"},ut={format:["code"],tag:"`",type:"text-format"},gt={format:["highlight"],tag:"==",type:"text-format"},pt={format:["bold","italic"],tag:"***",type:"text-format"},dt={format:["bold","italic"],intraword:!1,tag:"___",type:"text-format"},mt={format:["bold"],tag:"**",type:"text-format"},ht={format:["bold"],intraword:!1,tag:"__",type:"text-format"},xt={format:["strikethrough"],tag:"~~",type:"text-format"},Tt={format:["italic"],tag:"*",type:"text-format"},Ct={format:["italic"],intraword:!1,tag:"_",type:"text-format"},yt={dependencies:[L],export:(t,e,n)=>{if(!M(t))return null;const o=t.getTitle(),i=o?`[${t.getTextContent()}](${t.getURL()} "${o}")`:`[${t.getTextContent()}](${t.getURL()})`,s=t.getFirstChild();return 1===t.getChildrenSize()&&r(s)?n(s,i):i},importRegExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))/,regExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))$/,replace:(t,e)=>{const[,n,o,r]=e,s=N(o,{title:r}),c=i(n);c.setFormat(t.getFormat()),s.append(c),t.replace(s)},trigger:")",type:"text-match"},bt=[it,st,ct,lt,ft],vt=[ut,pt,dt,mt,ht,gt,Tt,Ct,xt],wt=[yt],Et=[...bt,...vt,...wt];function St(t,e=Et,n){return H(e)(t,n)}function $t(e=Et,n){const o=function(e){const n=_(e),o=n.textFormat.filter((t=>1===t.format.length));return e=>{const r=[],i=(e||t()).getChildren();for(const t of i){const e=z(t,n.element,o,n.textMatch);null!=e&&r.push(e)}return r.join("\n\n")}}(e);return o(n)}export{St as $convertFromMarkdownString,$t as $convertToMarkdownString,pt as BOLD_ITALIC_STAR,dt as BOLD_ITALIC_UNDERSCORE,mt as BOLD_STAR,ht as BOLD_UNDERSCORE,at as CHECK_LIST,ct as CODE,bt as ELEMENT_TRANSFORMERS,it as HEADING,gt as HIGHLIGHT,ut as INLINE_CODE,Tt as ITALIC_STAR,Ct as ITALIC_UNDERSCORE,yt as LINK,ft as ORDERED_LIST,st as QUOTE,xt as STRIKETHROUGH,vt as TEXT_FORMAT_TRANSFORMERS,wt as TEXT_MATCH_TRANSFORMERS,Et as TRANSFORMERS,lt as UNORDERED_LIST,et as registerMarkdownShortcuts};
