/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';var k=require("lexical"),u=require("@lexical/list"),z=require("@lexical/rich-text"),aa=require("@lexical/utils"),B=require("@lexical/code"),G=require("@lexical/link");function H(a,b){let c={};for(let d of a)a=b(d),c[a]?c[a].push(d):c[a]=[d];return c}function I(a){a=H(a,b=>b.type);return{element:a.element||[],textFormat:a["text-format"]||[],textMatch:a["text-match"]||[]}}let J=/[!-/:-@[-`{-~\s]/;
function ba(a){let b=I(a),c=b.textFormat.filter(d=>1===d.format.length);return d=>{let e=[];d=(d||k.$getRoot()).getChildren();for(let f of d)d=ca(f,b.element,c,b.textMatch),null!=d&&e.push(d);return e.join("\n\n")}}function ca(a,b,c,d){for(let e of b)if(b=e.export(a,f=>K(f,c,d)),null!=b)return b;return k.$isElementNode(a)?K(a,c,d):k.$isDecoratorNode(a)?a.getTextContent():null}
function K(a,b,c){let d=[];a=a.getChildren();a:for(let e of a){for(let f of c)if(a=f.export(e,g=>K(g,b,c),(g,l)=>L(g,l,b)),null!=a){d.push(a);continue a}k.$isLineBreakNode(e)?d.push("\n"):k.$isTextNode(e)?d.push(L(e,e.getTextContent(),b)):k.$isElementNode(e)?d.push(K(e,b,c)):k.$isDecoratorNode(e)&&d.push(e.getTextContent())}return d.join("")}
function L(a,b,c){let d=b.trim(),e=d,f=new Set;for(let l of c){c=l.format[0];let p=l.tag;if(M(a,c)&&!f.has(c)){f.add(c);var g=N(a,!0);M(g,c)||(e=p+e);g=N(a,!1);M(g,c)||(e+=p)}}return b.replace(d,()=>e)}
function N(a,b){let c=b?a.getPreviousSibling():a.getNextSibling();c||(a=a.getParentOrThrow(),a.isInline()&&(c=b?a.getPreviousSibling():a.getNextSibling()));for(;c;){if(k.$isElementNode(c)){if(!c.isInline())break;a=b?c.getLastDescendant():c.getFirstDescendant();if(k.$isTextNode(a))return a;c=b?c.getPreviousSibling():c.getNextSibling()}if(k.$isTextNode(c))return c;if(!k.$isElementNode(c))break}return null}function M(a,b){return k.$isTextNode(a)&&a.hasFormat(b)}
let O="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement,da=O&&"documentMode"in document?document.documentMode:null;O&&/Mac|iPod|iPhone|iPad/.test(navigator.platform);O&&/^(?!.*Seamonkey)(?=.*Firefox).*/i.test(navigator.userAgent);O&&"InputEvent"in window&&!da?"getTargetRanges"in new window.InputEvent("input"):!1;
let P=O&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent),Q=O&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,ea=O&&/Android/.test(navigator.userAgent),R=O&&/^(?=.*Chrome).*/i.test(navigator.userAgent);O&&ea&&R;let S=O&&/AppleWebKit\/[\d.]+/.test(navigator.userAgent)&&!R,fa=/^\s{0,3}$/;
function ha(a){let b=I(a),c=ia(b.textFormat);return(d,e)=>{d=d.split("\n");let f=d.length;e=e||k.$getRoot();e.clear();for(let h=0;h<f;h++){var g=d[h],l=!1;for(var p of b.element)if(p.getNumberOfLines){var q=g.match(p.regExp),x=p.getNumberOfLines(d,h);if(!(h+x>=d.length)){var r=d[h+x].match(p.regExp),n=k.$createTextNode(d.slice(h+1,h+x).join("\n"));if(q&&r){l=k.$createParagraphNode();l.append(n);e.append(l);p.replace(l,[n],q,!0);h+=x;l=!0;break}}}if(!l){q=g;var t=e,m=b.element;x=c;n=b.textMatch;l=
q.trim();r=k.$createTextNode(l);g=k.$createParagraphNode();g.append(r);t.append(g);t=!1;for(let {regExp:v,replace:w}of m)if(m=q.match(v)){t=!0;r.setTextContent(q.slice(m[0].length));w(g,[r],m,!0);break}t||g.select(0,0);T(r,x,n);g.isAttached()&&0<l.length&&(q=g.getPreviousSibling(),k.$isParagraphNode(q)||z.$isQuoteNode(q)||u.$isListNode(q))&&(x=q,u.$isListNode(q)&&(q=q.getLastDescendant(),x=null==q?null:aa.$findMatchingParent(q,u.$isListItemNode)),null!=x&&0<x.getTextContentSize()&&(x.splice(x.getChildrenSize(),
0,[k.$createLineBreakNode(),...g.getChildren()]),g.remove()))}}p=e.getChildren();for(let h of p)p=h,k.$isParagraphNode(p)?(d=p.getFirstChild(),p=null==d||1===p.getChildrenSize()&&k.$isTextNode(d)&&fa.test(d.getTextContent())):p=!1,p&&1<e.getChildrenSize()&&h.remove();null!==k.$getSelection()&&e.selectEnd()}}
function T(a,b,c){var d=a.getTextContent();let e=ja(d,b);if(e){var f,g;if(e[0]===d)var l=a;else{d=e.index||0;let p=d+e[0].length;0===d?[l,f]=a.splitText(p):[g,l,f]=a.splitText(d,p)}l.setTextContent(e[2]);if(a=b.transformersByTag[e[1]])for(let p of a.format)l.hasFormat(p)||l.toggleFormat(p);l.hasFormat("code")||T(l,b,c);g&&T(g,b,c);f&&T(f,b,c)}else U(a,c)}
function U(a,b){a:for(;a;){for(let c of b){let d=a.getTextContent().match(c.importRegExp);if(!d)continue;let e=d.index||0,f=e+d[0].length,g,l;0===e?[g,a]=a.splitText(f):[,g,l]=a.splitText(e,f);l&&U(l,b);c.replace(g,d);continue a}break}}
function ja(a,b){var c=a.match(b.openTagsRegExp);if(null==c)return null;for(let f of c){var d=f.replace(/^\s/,"");c=b.fullMatchRegExpByTag[d];if(null!=c&&(c=a.match(c),d=b.transformersByTag[d],null!=c&&null!=d)){if(!1!==d.intraword)return c;var {index:e=0}=c;d=a[e-1];e=a[e+c[0].length];if(!(d&&!J.test(d)||e&&!J.test(e)))return c}}return null}
function ia(a){let b={},c={},d=[];for(let e of a){({tag:a}=e);b[a]=e;let f=a.replace(/(\*|\^|\+)/g,"\\$1");d.push(f);c[a]=P||Q||S?new RegExp(`(${f})(?![${f}\\s])(.*?[^${f}\\s])${f}(?!${f})`):new RegExp(`(?<![\\\\${f}])(${f})((\\\\${f})?.*?[^${f}\\s](\\\\${f})?)((?<!\\\\)|(?<=\\\\\\\\))(${f})(?![\\\\${f}])`)}return{fullMatchRegExpByTag:c,openTagsRegExp:new RegExp((P||Q||S?"":"(?<![\\\\])")+"("+d.join("|")+")","g"),transformersByTag:b}}
function V(a,b,c){let d=c.length;for(;b>=d;b--){let e=b-d;if(W(a,e,c,0,d)&&" "!==a[e+d])return e}return-1}function W(a,b,c,d,e){for(let f=0;f<e;f++)if(a[b+f]!==c[d+f])return!1;return!0}
let ka=a=>(b,c,d)=>{d=a(d);d.append(...c);b.replace(d);d.select(0,0)},X=a=>(b,c,d)=>{var e=b.getPreviousSibling(),f=b.getNextSibling();const g=u.$createListItemNode("check"===a?"x"===d[3]:void 0);u.$isListNode(f)&&f.getListType()===a?(e=f.getFirstChild(),null!==e?e.insertBefore(g):f.append(g),b.remove()):u.$isListNode(e)&&e.getListType()===a?(e.append(g),b.remove()):(f=u.$createListNode(a,"number"===a?Number(d[2]):void 0),f.append(g),b.replace(f));g.append(...c);g.select(0,0);c=d[1];b=c.match(/\t/g);
c=c.match(/ /g);d=0;b&&(d+=b.length);c&&(d+=Math.floor(c.length/4));(b=d)&&g.setIndent(b)},Y=(a,b,c)=>{const d=[];var e=a.getChildren();let f=0;for(const l of e)if(u.$isListItemNode(l)){if(1===l.getChildrenSize()&&(e=l.getFirstChild(),u.$isListNode(e))){d.push(Y(e,b,c+1));continue}e=" ".repeat(4*c);var g=a.getListType();g="number"===g?`${a.getStart()+f}. `:"check"===g?`- [${l.getChecked()?"x":" "}] `:"- ";d.push(e+g+b(l));f++}return d.join("\n")},la={dependencies:[z.HeadingNode],export:(a,b)=>{if(!z.$isHeadingNode(a))return null;
const c=Number(a.getTag().slice(1));return"#".repeat(c)+" "+b(a)},regExp:/^(#{1,6})\s/,replace:ka(a=>z.$createHeadingNode("h"+a[1].length)),type:"element"},ma={dependencies:[z.QuoteNode],export:(a,b)=>{if(!z.$isQuoteNode(a))return null;a=b(a).split("\n");b=[];for(const c of a)b.push("> "+c);return b.join("\n")},regExp:/^>\s/,replace:(a,b,c,d)=>{if(d&&(c=a.getPreviousSibling(),z.$isQuoteNode(c))){c.splice(c.getChildrenSize(),0,[k.$createLineBreakNode(),...b]);c.select(0,0);a.remove();return}c=z.$createQuoteNode();
c.append(...b);a.replace(c);c.select(0,0)},type:"element"},na={dependencies:[B.CodeNode],export:a=>{if(!B.$isCodeNode(a))return null;const b=a.getTextContent();return"```"+(a.getLanguage()||"")+(b?"\n"+b:"")+"\n```"},getNumberOfLines:(a,b)=>{const c=/^```(\w{1,10})?\s?$/;let d=b;const e=a.length;for(;++d<e;)if(a[d].match(c))return d-b;return 1},regExp:/^```(\w{1,10})?\s?$/,replace:ka(a=>B.$createCodeNode(a?a[1]:void 0)),type:"element"},oa={dependencies:[u.ListNode,u.ListItemNode],export:(a,b)=>u.$isListNode(a)?
Y(a,b,0):null,regExp:/^(\s*)[-*+]\s/,replace:X("bullet"),type:"element"},pa={dependencies:[u.ListNode,u.ListItemNode],export:(a,b)=>u.$isListNode(a)?Y(a,b,0):null,regExp:/^(\s*)(?:-\s)?\s?(\[(\s|x)?\])\s/i,replace:X("check"),type:"element"},qa={dependencies:[u.ListNode,u.ListItemNode],export:(a,b)=>u.$isListNode(a)?Y(a,b,0):null,regExp:/^(\s*)(\d{1,})\.\s/,replace:X("number"),type:"element"},ra={format:["code"],tag:"`",type:"text-format"},sa={format:["highlight"],tag:"==",type:"text-format"},ta={format:["bold",
"italic"],tag:"***",type:"text-format"},va={format:["bold","italic"],intraword:!1,tag:"___",type:"text-format"},wa={format:["bold"],tag:"**",type:"text-format"},xa={format:["bold"],intraword:!1,tag:"__",type:"text-format"},ya={format:["strikethrough"],tag:"~~",type:"text-format"},za={format:["italic"],tag:"*",type:"text-format"},Aa={format:["italic"],intraword:!1,tag:"_",type:"text-format"},Ba={dependencies:[G.LinkNode],export:(a,b,c)=>{if(!G.$isLinkNode(a))return null;b=(b=a.getTitle())?`[${a.getTextContent()}](${a.getURL()} "${b}")`:
`[${a.getTextContent()}](${a.getURL()})`;const d=a.getFirstChild();return 1===a.getChildrenSize()&&k.$isTextNode(d)?c(d,b):b},importRegExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))/,regExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))$/,replace:(a,b)=>{const [,c,d,e]=b;b=G.$createLinkNode(d,{title:e});const f=k.$createTextNode(c);f.setFormat(a.getFormat());b.append(f);a.replace(b)},trigger:")",type:"text-match"},Ca=[la,ma,na,oa,qa],Da=[ra,ta,va,
wa,xa,sa,za,Aa,ya],Ea=[Ba],Z=[...Ca,...Da,...Ea];exports.$convertFromMarkdownString=function(a,b=Z,c){return ha(b)(a,c)};exports.$convertToMarkdownString=function(a=Z,b){return ba(a)(b)};exports.BOLD_ITALIC_STAR=ta;exports.BOLD_ITALIC_UNDERSCORE=va;exports.BOLD_STAR=wa;exports.BOLD_UNDERSCORE=xa;exports.CHECK_LIST=pa;exports.CODE=na;exports.ELEMENT_TRANSFORMERS=Ca;exports.HEADING=la;exports.HIGHLIGHT=sa;exports.INLINE_CODE=ra;exports.ITALIC_STAR=za;exports.ITALIC_UNDERSCORE=Aa;exports.LINK=Ba;
exports.ORDERED_LIST=qa;exports.QUOTE=ma;exports.STRIKETHROUGH=ya;exports.TEXT_FORMAT_TRANSFORMERS=Da;exports.TEXT_MATCH_TRANSFORMERS=Ea;exports.TRANSFORMERS=Z;exports.UNORDERED_LIST=oa;
exports.registerMarkdownShortcuts=function(a,b=Z){let c=I(b),d=H(c.textFormat,({tag:f})=>f[f.length-1]),e=H(c.textMatch,({trigger:f})=>f);for(let f of b)if(b=f.type,"element"===b||"text-match"===b){b=f.dependencies;for(let g of b)if(!a.hasNode(g))throw Error(`MarkdownShortcuts: missing dependency ${g.getType()} for transformer. Ensure node dependency is included in editor initial config.`);}return a.registerUpdateListener(({tags:f,dirtyLeaves:g,editorState:l,prevEditorState:p})=>{if(!f.has("collaboration")&&
!f.has("historic")&&!a.isComposing()){var q=l.read(k.$getSelection);f=p.read(k.$getSelection);if(k.$isRangeSelection(f)&&k.$isRangeSelection(q)&&q.isCollapsed()){p=q.anchor.key;var x=q.anchor.offset,r=l._nodeMap.get(p);!k.$isTextNode(r)||!g.has(p)||1!==x&&x>f.anchor.offset+1||a.update(()=>{if(!r.hasFormat("code")){var n=r.getParent();if(null!==n&&!B.$isCodeNode(n)){var t=q.anchor.offset;b:{var m=c.element,h=n.getParent();if(k.$isRootOrShadowRoot(h)&&n.getFirstChild()===r&&(h=r.getTextContent()," "===
h[t-1]))for(let {regExp:D,replace:E}of m)if((m=h.match(D))&&m[0].length===t){h=r.getNextSiblings();let [F,ua]=r.splitText(t);F.remove();h=ua?[ua,...h]:h;E(n,h,m,!1);n=!0;break b}n=!1}if(!n){b:{m=r.getTextContent();n=e[m[t-1]];if(null!=n){t<m.length&&(m=m.slice(0,t));for(w of n)if(n=m.match(w.regExp),null!==n){m=n.index||0;h=m+n[0].length;var v=void 0;0===m?[v]=r.splitText(h):[,v]=r.splitText(m,h);v.selectNext(0,0);w.replace(v,n);var w=!0;break b}}w=!1}if(!w)b:{h=r.getTextContent();--t;var y=h[t];
if(w=d[y])for(let D of w){var {tag:C}=D;w=C.length;let E=t-w+1;if(!(1<w&&!W(h,E,C,0,w)||" "===h[E-1])&&(v=h[t+1],!1!==D.intraword||!v||J.test(v))){n=v=r;m=V(h,E,C);for(var A=n;0>m&&(A=A.getPreviousSibling())&&!k.$isLineBreakNode(A);)k.$isTextNode(A)&&(m=A.getTextContent(),n=A,m=V(m,m.length,C));if(!(0>m||n===v&&m+w===E||(C=n.getTextContent(),0<m&&C[m-1]===y||(A=C[m-1],!1===D.intraword&&A&&!J.test(A))))){h=v.getTextContent();h=h.slice(0,E)+h.slice(t+1);v.setTextContent(h);h=n===v?h:C;n.setTextContent(h.slice(0,
m)+h.slice(m+w));h=k.$getSelection();y=k.$createRangeSelection();k.$setSelection(y);t=t-w*(n===v?2:1)+1;y.anchor.set(n.__key,m,"text");y.focus.set(v.__key,t,"text");for(let F of D.format)y.hasFormat(F)||y.formatText(F);y.anchor.set(y.focus.key,y.focus.offset,y.focus.type);for(let F of D.format)y.hasFormat(F)&&y.toggleFormat(F);k.$isRangeSelection(h)&&(y.format=h.format);break b}}}}}}}})}}})}
